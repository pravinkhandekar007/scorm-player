// **Corrected Logic for upload.html <script>**

// Assume you have defined 'supabase', 'SUPABASE_URL', and 'uploadBtn'
uploadBtn.addEventListener('click', async () => {
    // 1. Get the current session
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();

    if (sessionError || !session) {
        uploadMessage.textContent = "Error: Please log in before uploading a file.";
        return;
    }

    const scormFile = document.getElementById('scormFile').files[0];
    const userId = session.user.id; // Get the user's ID from the authenticated session

    const formData = new FormData();
    formData.append('scormFile', scormFile);
    formData.append('userId', userId); // Sending ID is okay, but JWT verification is the source of truth

    uploadMessage.textContent = 'Uploading and processing file...';

    try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/process-scorm-upload`, {
            method: 'POST',
            headers: {
                // ✅ CRITICAL FIX: Include the Authorization header with the JWT
                'Authorization': `Bearer ${session.access_token}`, 
                'apikey': SUPABASE_ANON_KEY,
            },
            body: formData
        });

        const result = await response.json();

        if (!response.ok) {
            // Log the detailed error from the server (which contained the 401 JSON)
            throw new Error(result.message || JSON.stringify(result));
        }

        uploadMessage.innerHTML = `✅ Success! Course uploaded and processed. Launch URL: <a href="scorm-player.html?course=${result.course_slug}" target="_blank">Launch Course</a>`;

    } catch (error) {
        console.error("Upload Error:", error);
        uploadMessage.textContent = `❌ Upload failed: ${error.message}.`;
    }
});
