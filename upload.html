<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SCORM Package Upload</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .upload-area, #authSection {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: border-color 0.3s;
        }
        .upload-area.dragover { border-color: #007bff; background-color: #f8f9fa; }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn:hover { background-color: #0056b3; }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        #uploadArea { display: none; }
    </style>
</head>
<body>
<h1>üéì SCORM Course Upload</h1>

<div id="authSection">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Your email" /><br><br>
    <input type="password" id="password" placeholder="Password" /><br><br>
    <button id="loginBtn" class="btn">Login</button>
    <button id="logoutBtn" class="btn" style="display:none;">Logout</button>
    <p id="authMessage"></p>
</div>

<div class="upload-area" id="uploadArea">
    <h3>üìÅ Drop your SCORM package here</h3>
    <p>or</p>
    <input type="file" id="fileInput" accept=".zip" style="display:none;" />
    <button class="btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
</div>

<div id="uploadProgress" style="display:none;">
    <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
    <p id="progressText">Uploading...</p>
</div>

<div id="result"></div>

<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://kfksfnzpudycqbcftrev.supabase.co";
    const SUPABASE_ANON_KEY = "your-anon-public-key";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const authSection = document.getElementById('authSection');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authMessage = document.getElementById('authMessage');

    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    const progressDiv = document.getElementById("uploadProgress");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const result = document.getElementById("result");

    async function checkAuth() {
        const { data: { session }} = await supabase.auth.getSession();
        if (session) {
            authMessage.textContent = `Logged in as ${session.user.email}`;
            loginBtn.style.display = "none";
            logoutBtn.style.display = "inline-block";
            uploadArea.style.display = "block";
        } else {
            authMessage.textContent = "Not logged in";
            loginBtn.style.display = "inline-block";
            logoutBtn.style.display = "none";
            uploadArea.style.display = "none";
        }
    }

    loginBtn.addEventListener("click", async () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) {
            authMessage.textContent = "Please enter email and password.";
            return;
        }
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
            authMessage.textContent = `Login error: ${error.message}`;
        } else {
            authMessage.textContent = "Login successful!";
            await checkAuth();
        }
    });

    logoutBtn.addEventListener("click", async () => {
        await supabase.auth.signOut();
        await checkAuth();
    });

    fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
            handleFileUpload(e.target.files[0]);
        }
    });

    uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
    });

    uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
    });

    uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileUpload(files[0]);
        }
    });

    async function handleFileUpload(file) {
        if (!file.name.toLowerCase().endsWith(".zip")) {
            showResult("Please select a ZIP file containing your SCORM package.", "error");
            return;
        }
        progressDiv.style.display = "block";
        result.innerHTML = "";

        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) throw new Error("User not logged in");

            const formData = new FormData();
            formData.append("scormFile", file);
            formData.append("userId", session.user.id);

            progressText.textContent = "Processing SCORM package...";
            progressBar.style.width = "50%";

            const response = await fetch(`https://kfksfnzpudycqbcftrev.supabase.co/functions/v1/process-scorm-upload`, {
                method: "POST",
                headers: {
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtma3NmbnpwdWR5Y3FiY2Z0cmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODg1MzcsImV4cCI6MjA3NDI2NDUzN30.l0ApEczfprHX9m73tiCWzO2cJRGBpic9RDJWQsw7qfs',
                    'Authorization': `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtma3NmbnpwdWR5Y3FiY2Z0cmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODg1MzcsImV4cCI6MjA3NDI2NDUzN30.l0ApEczfprHX9m73tiCWzO2cJRGBpic9RDJWQsw7qfs`,
                },
                body: formData,
            });

            progressBar.style.width = "100%";
            progressText.textContent = "Upload complete!";

            const data = await response.json();
            if (data.success) {
                showResult(
                    `‚úÖ Course uploaded successfully!<br>
                     <strong>Share URL:</strong> <a href="${data.shareUrl}" target="_blank">${data.shareUrl}</a><br>
                     <button class="btn" onclick="copyToClipboard('${data.shareUrl}')">Copy Link</button>`,
                    "success"
                );
            } else {
                throw new Error(data.error || "Upload failed");
            }
        } catch (error) {
            showResult(`‚ùå Error: ${error.message}`, "error");
        } finally {
            progressDiv.style.display = "none";
        }
    }

    function showResult(message, type) {
        result.innerHTML = `<div class="result ${type}">${message}</div>`;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert("Link copied to clipboard!");
        });
    }

    checkAuth();
</script>
</body>
</html>
