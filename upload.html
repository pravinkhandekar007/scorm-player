<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // Replace these with your actual Supabase project URL and anon public key
  const SUPABASE_URL = 'https://kfksfnzpudycqbcftrev.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtma3NmbnpwdWR5Y3FiY2Z0cmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODg1MzcsImV4cCI6MjA3NDI2NDUzN30.l0ApEczfprHX9m73tiCWzO2cJRGBpic9RDJWQsw7qfs';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ... your existing code ...

  async function handleFileUpload(file) {
    if (!file.name.toLowerCase().endsWith('.zip')) {
      showResult('Please select a ZIP file containing your SCORM package.', 'error');
      return;
    }

    progressDiv.style.display = 'block';
    result.innerHTML = '';

    try {
      const formData = new FormData();
      formData.append('scormFile', file);
      formData.append('userId', getUserId()); // Your existing userId function

      progressText.textContent = 'Processing SCORM package...';
      progressBar.style.width = '50%';

      // Get current user session to extract access token
      const { data: { session } } = await supabase.auth.getSession();
      const userAccessToken = session?.access_token || '';

      const response = await fetch('https://kfksfnzpudycqbcftrev.supabase.co/functions/v1/process-scorm-upload', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${userAccessToken}`,
          'apikey': SUPABASE_ANON_KEY,
        },
        body: formData
      });

      progressBar.style.width = '100%';
      progressText.textContent = 'Upload complete!';

      const data = await response.json();
      console.log('Upload response data:', data);

      if (data.success) {
        showResult(
          `✅ Course uploaded successfully!
           <br><br>
           <strong>Share URL:</strong> <a href="${data.shareUrl}" target="_blank">${data.shareUrl}</a>
           <br><br>
           <button class="btn" onclick="copyToClipboard('${data.shareUrl}')">Copy Link</button>`,
          'success'
        );
      } else {
        throw new Error(data.error || 'Upload failed');
      }
    } catch (error) {
      console.error('Upload error:', error);
      showResult(`❌ Error: ${error.message}`, 'error');
    } finally {
      progressDiv.style.display = 'none';
    }
  }
</script>
