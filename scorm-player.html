<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://kfksfnzpudycqbcftrev.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtma3NmbnpwdWR5Y3FiY2Z0cmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODg1MzcsImV4cCI6MjA3NDI2NDUzN30.l0ApEczfprHX9m73tiCWzO2cJRGBpic9RDJWQsw7qfs";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const authSection = document.getElementById("authSection");
    // ... (Keep other auth-related element definitions if you want to keep the login UI)

    // --- New Player Elements (Ensure these exist in the HTML body) ---
    // You should add these elements to the HTML body above the script:
    // <div id="playerContainer" style="display:none; height: 100vh;">
    //     <iframe id="scormIframe" style="width: 100%; height: 100%; border: none;"></iframe>
    // </div>
    // <div id="courseLoadMessage">Initializing player...</div>
    const playerContainer = document.getElementById("playerContainer");
    const scormIframe = document.getElementById("scormIframe");
    const courseLoadMessage = document.getElementById("courseLoadMessage");
    // -----------------------------------------------------------------


    async function loadCourse(session) {
        const urlParams = new URLSearchParams(window.location.search);
        const courseSlug = urlParams.get('course');
        
        if (!courseSlug) {
            courseLoadMessage.textContent = "Error: No course slug provided in the URL.";
            return;
        }

        courseLoadMessage.textContent = `Loading course: ${courseSlug}...`;
        
        try {
            // 1. Fetch Course Metadata (Edge Function 2)
            const edgeFunctionUrl = `${SUPABASE_URL}/functions/v1/get-course/${courseSlug}`;

            const response = await fetch(edgeFunctionUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${session.access_token}`, // ✅ CRITICAL FIX: Use user's JWT
                    'apikey': SUPABASE_ANON_KEY,
                },
            });
            
            if (!response.ok) {
                // Throw an error with the status code for better debugging
                throw new Error(`Failed to load course metadata: ${response.status}`);
            }

            const course = await response.json();
            
            // 2. Construct SCORM Content Launch URL (via Edge Function 3 Proxy)
            const launchPath = `${course.package_path}/${course.launch_url}`;
            // The third Edge Function is named `proxy-scorm`, use that path
            const scormContentUrl = `${SUPABASE_URL}/functions/v1/proxy-scorm/${launchPath}`; 

            // 3. Display the SCORM Content
            scormIframe.src = scormContentUrl;
            
            playerContainer.style.display = "block";
            courseLoadMessage.style.display = "none";
            // Hide auth section once player loads
            if (authSection) authSection.style.display = "none"; 

        } catch (error) {
            console.error("Course Loading Error:", error);
            courseLoadMessage.textContent = `❌ Error: ${error.message}`;
        }
    }


    async function checkAuth() {
        const { data: { session } } = await supabase.auth.getSession();
        
        if (session) {
            // ... (keep logic for updating authMessage/buttons for logged in state)
            
            if (!session.user.email_confirmed_at) {
                // Handle unverified email
                // ...
            } else {
                // User is authenticated, proceed to load course
                await loadCourse(session);
            }
        } else {
            // ... (keep logic for updating authMessage/buttons for logged out state)
            
            // Display a message prompting login if course param exists
            const courseSlug = new URLSearchParams(window.location.search).get('course');
            if (courseSlug) {
                 courseLoadMessage.textContent = "Please log in to view this course.";
                 // Show only the auth section
                 if (authSection) authSection.style.display = "block";
            }
        }
    }

    // (Keep signupBtn, loginBtn, logoutBtn event listeners, and helper functions)
    // ...
    
    // Initial check
    checkAuth();
</script>
