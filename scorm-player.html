<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM Player</title>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #player-container { width: 100%; height: 100vh; position: relative; }
        #content-frame { width: 100%; height: 100%; border: none; }
        #loading { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 18px; 
        }
    </style>
</head>
<body>
    <div id="player-container">
        <div id="loading">Loading SCORM content...</div>
        <iframe id="content-frame" style="display: none;"></iframe>
    </div>

    <script src="scorm-api.js"></script>
    <script>
        // Initialize SCORM player
        class ScormPlayer {
            constructor(courseSlug) {
                this.courseSlug = courseSlug;
                this.sessionId = this.generateSessionId();
                this.cmiData = this.initializeCMI();
                this.setupAPI();
                this.loadCourse();
            }

            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            initializeCMI() {
                return {
                    "cmi.core.lesson_status": "not attempted",
                    "cmi.core.entry": "ab-initio",
                    "cmi.core.learner_id": "anonymous_" + Date.now(),
                    "cmi.core.learner_name": "Anonymous User",
                    "cmi.core.score.raw": "",
                    "cmi.core.score.max": "100",
                    "cmi.core.score.min": "0",
                    "cmi.core.session_time": "00:00:00",
                    "cmi.core.total_time": "00:00:00",
                    "cmi.suspend_data": "",
                    "cmi.launch_data": "",
                    "cmi.comments": "",
                    "cmi.comments_from_lms": "",
                    "cmi.core.lesson_location": ""
                };
            }

            setupAPI() {
                // Create SCORM 1.2 API
                window.API = {
                    LMSInitialize: (param) => {
                        console.log("LMSInitialize called");
                        return "true";
                    },

                    LMSFinish: (param) => {
                        console.log("LMSFinish called");
                        this.saveCMIData();
                        return "true";
                    },

                    LMSGetValue: (element) => {
                        console.log("LMSGetValue:", element);
                        return this.cmiData[element] || "";
                    },

                    LMSSetValue: (element, value) => {
                        console.log("LMSSetValue:", element, value);
                        this.cmiData[element] = value;
                        return "true";
                    },

                    LMSCommit: (param) => {
                        console.log("LMSCommit called");
                        this.saveCMIData();
                        return "true";
                    },

                    LMSGetLastError: () => "0",
                    LMSGetErrorString: (errorCode) => "No Error",
                    LMSGetDiagnostic: (param) => ""
                };

                // Create SCORM 2004 API
                window.API_1484_11 = {
                    Initialize: (param) => {
                        console.log("Initialize called");
                        return "true";
                    },

                    Terminate: (param) => {
                        console.log("Terminate called");
                        this.saveCMIData();
                        return "true";
                    },

                    GetValue: (element) => {
                        console.log("GetValue:", element);
                        // Map SCORM 2004 elements to 1.2 format
                        const scorm2004To12 = {
                            "cmi.completion_status": "cmi.core.lesson_status",
                            "cmi.learner_id": "cmi.core.learner_id",
                            "cmi.learner_name": "cmi.core.learner_name",
                            "cmi.location": "cmi.core.lesson_location",
                            "cmi.score.raw": "cmi.core.score.raw",
                            "cmi.score.max": "cmi.core.score.max",
                            "cmi.score.min": "cmi.core.score.min"
                        };
                        
                        const mappedElement = scorm2004To12[element] || element;
                        return this.cmiData[mappedElement] || "";
                    },

                    SetValue: (element, value) => {
                        console.log("SetValue:", element, value);
                        // Map SCORM 2004 elements to 1.2 format
                        const scorm2004To12 = {
                            "cmi.completion_status": "cmi.core.lesson_status",
                            "cmi.learner_id": "cmi.core.learner_id",
                            "cmi.learner_name": "cmi.core.learner_name",
                            "cmi.location": "cmi.core.lesson_location",
                            "cmi.score.raw": "cmi.core.score.raw",
                            "cmi.score.max": "cmi.core.score.max",
                            "cmi.score.min": "cmi.core.score.min"
                        };
                        
                        const mappedElement = scorm2004To12[element] || element;
                        this.cmiData[mappedElement] = value;
                        return "true";
                    },

                    Commit: (param) => {
                        console.log("Commit called");
                        this.saveCMIData();
                        return "true";
                    },

                    GetLastError: () => "0",
                    GetErrorString: (errorCode) => "No Error",
                    GetDiagnostic: (param) => ""
                };
            }

            async loadCourse() {
                try {
                    // Fetch course metadata
                    const response = await fetch(`/api/courses/${this.courseSlug}`);
                    const courseData = await response.json();
                    
                    if (!courseData) {
                        throw new Error("Course not found");
                    }

                    // Load the course content
                    const contentUrl = `${courseData.package_path}/${courseData.launch_url}`;
                    const iframe = document.getElementById('content-frame');
                    
                    iframe.onload = () => {
                        document.getElementById('loading').style.display = 'none';
                        iframe.style.display = 'block';
                    };
                    
                    iframe.src = contentUrl;

                } catch (error) {
                    console.error("Error loading course:", error);
                    document.getElementById('loading').textContent = "Error loading course: " + error.message;
                }
            }

            async saveCMIData() {
                try {
                    const response = await fetch(`/api/sessions/${this.sessionId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            courseSlug: this.courseSlug,
                            cmiData: this.cmiData,
                            sessionId: this.sessionId
                        })
                    });

                    if (!response.ok) {
                        throw new Error("Failed to save CMI data");
                    }

                    console.log("CMI data saved successfully");
                } catch (error) {
                    console.error("Error saving CMI data:", error);
                }
            }
        }

        // Initialize player when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const urlParts = window.location.pathname.split('/');
            const courseSlug = urlParts[urlParts.length - 1];
            
            if (courseSlug) {
                new ScormPlayer(courseSlug);
            } else {
                document.getElementById('loading').textContent = "Invalid course URL";
            }
        });
    </script>
</body>
</html>
