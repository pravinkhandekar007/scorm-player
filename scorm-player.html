<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SCORM Player</title>
  <!-- styles unchanged -->
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéì SCORM Course Player</h1>
      <p id="courseTitle">Loading course...</p>
    </div>

    <div id="loading" class="loading">üìö Loading course content...</div>

    <div id="error" class="error" style="display: none;">
      ‚ùå <span id="errorMessage"></span>
    </div>

    <div id="courseInfo" class="course-info" style="display: none;">
      <strong>Course:</strong> <span id="courseTitleInfo"></span>
    </div>

    <iframe id="courseFrame" class="course-frame" style="display: none;"></iframe>
  </div>

  <script>
    const SUPABASE_URL = "https://kfksfnzpudycqbcftrev.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";

    async function loadCourse() {
      try {
        const params = new URLSearchParams(window.location.search);
        const courseSlug = params.get("course");
        if (!courseSlug) throw new Error("No course specified in URL");

        const metaRes = await fetch(
          `${SUPABASE_URL}/functions/v1/get-course/${courseSlug}`,
          {
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
          }
        );
        if (!metaRes.ok)
          throw new Error(`Failed to load course metadata: ${metaRes.status}`);
        const course = await metaRes.json();

        document.getElementById("courseTitle").textContent = course.title;
        document.getElementById("courseTitleInfo").textContent = course.title;
        document.getElementById("courseInfo").style.display = "block";

        const launchUrl = await getLaunchFile(course);
        document.getElementById("loading").style.display = "none";
        const iframe = document.getElementById("courseFrame");
        iframe.src = launchUrl;
        iframe.style.display = "block";
      } catch (err) {
        console.error(err);
        showError(`Error loading content: ${err.message}`);
      }
    }

    async function getLaunchFile(course) {
      // Public URL for the SCORM manifest
      const publicUrl =
        `${SUPABASE_URL}/storage/v1/object/public/scorm-packages/` +
        `${course.package_path}/${course.launch_url}`;
      console.log("Using public manifest URL:", publicUrl);
      return publicUrl;
    }

    function showError(message) {
      document.getElementById("loading").style.display = "none";
      document.getElementById("errorMessage").textContent = message;
      document.getElementById("error").style.display = "block";
    }

    document.addEventListener("DOMContentLoaded", loadCourse);
  </script>
</body>
</html>
