<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCORM Course Player</title>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f4f4f4; }
        #player-container { width: 100%; max-width: 1200px; margin: 20px auto; background-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #course-iframe { width: 100%; height: 600px; border: none; }
        #message { padding: 20px; text-align: center; color: red; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div id="player-container">
    <h2>SCORM Course Player</h2>
    <div id="message">Loading...</div>
    <iframe id="course-iframe" src="" allowfullscreen></iframe>
</div>

<script>
    // =========================================================
    // 1. CONFIGURATION
    // IMPORTANT: Replace these placeholders with your actual Supabase details
    const SUPABASE_URL = 'https://kfksfnzpudycqbcftrev.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtma3NmbnpwdWR5Y3FiY2Z0cmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODg1MzcsImV4cCI6MjA3NDI2NDUzN30.l0ApEczfprHX9m73tiCWzO2cJRGBpic9RDJWQsw7qfs'; 

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const messageDiv = document.getElementById('message');
    const iframe = document.getElementById('course-iframe');
    const courseSlug = new URLSearchParams(window.location.search).get('course');
    
    // Global variable to hold the token, set once at initialization
    let userAccessToken = null;

    // =========================================================
    // 2. AUTHORIZATION AND FILE FETCHING (CRITICAL FIX: Use global token)
    
    // ðŸŽ¯ FIX: loadCourseFile now uses the global userAccessToken variable
    async function loadCourseFile(filePath) {
        if (!userAccessToken) {
            console.error("Authentication Error: userAccessToken is not set.");
            throw new Error("User not authorized. Session missing.");
        }
        
        // Construct the URL to the proxy-scorm Edge Function
        const fileUrl = `${SUPABASE_URL}/functions/v1/proxy-scorm/${courseSlug}/${filePath}`;

        const response = await fetch(fileUrl, {
            method: 'GET',
            headers: {
                // THE CRITICAL FIX: Send the Bearer Token from the globally stored variable
                'Authorization': `Bearer ${userAccessToken}`, 
                'apikey': SUPABASE_ANON_KEY, 
            }
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`Error loading file ${filePath}: Status ${response.status}`, errorText);
            throw new Error(`Failed to load file (${filePath}): Status ${response.status}`);
        }

        return response.arrayBuffer(); 
    }

    // =========================================================
    // 3. SCORM MANIFEST PARSING AND LAUNCH LOGIC (Kept the same)

    function extractLaunchUrl(xmlString) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "application/xml");
            
            if (xmlDoc.getElementsByTagName("parsererror").length) {
                console.error("XML Parsing Error:", xmlDoc.getElementsByTagName("parsererror")[0].textContent);
                throw new Error("Invalid SCORM manifest XML.");
            }

            const resource = xmlDoc.querySelector('resource[href]');

            if (resource) {
                return resource.getAttribute('href');
            }

            const defaultActivity = xmlDoc.querySelector('organization[default="true"] > item[identifierref][identifier]');
            if (defaultActivity) {
                const identifierRef = defaultActivity.getAttribute('identifierref');
                const resourceByRef = xmlDoc.querySelector(`resource[identifier="${identifierRef}"][href]`);
                if (resourceByRef) {
                    return resourceByRef.getAttribute('href');
                }
            }

            console.warn("Could not find launch URL in manifest. Defaulting to index.html.");
            return 'index.html'; 
            
        } catch (e) {
            console.error("Error processing manifest:", e);
            messageDiv.textContent = `Error processing manifest: ${e.message}`;
            return null;
        }
    }

    async function loadCourse() {
        messageDiv.textContent = "Authenticating and fetching manifest...";
        
        if (!courseSlug) {
            messageDiv.textContent = "Error: Missing 'course' slug in the URL.";
            return;
        }

        try {
            // ðŸŽ¯ FIX: 1. Get the session ONCE before fetching files
            const { data: { session } } = await supabase.auth.getSession(); 
            
            if (!session || !session.access_token) {
                messageDiv.textContent = "Authentication Error: User session not found. Please log in.";
                messageDiv.style.color = 'red';
                console.error("User session is not available. Cannot fetch course.");
                return;
            }
            
            // Set the global token for loadCourseFile to use
            userAccessToken = session.access_token;

            // 2. Fetch the imsmanifest.xml file using the authorized function
            const manifestArrayBuffer = await loadCourseFile('imsmanifest.xml');
            
            // Convert ArrayBuffer to string (manifest is always text/XML)
            const manifestString = new TextDecoder('utf-8').decode(manifestArrayBuffer);

            // 3. Extract the launch URL
            const launchUrl = extractLaunchUrl(manifestString);

            if (!launchUrl) {
                messageDiv.textContent = "Error: Failed to determine the course launch URL from manifest.";
                return;
            }

            // 4. Prepare the final launch URL to the proxy function
            const finalLaunchPath = `${SUPABASE_URL}/functions/v1/proxy-scorm/${courseSlug}/${launchUrl}`;
            
            // 5. Set the iframe source
            iframe.src = finalLaunchPath;
            messageDiv.textContent = `Course content launched.`;
            messageDiv.style.color = 'green';
            
        } catch (error) {
            // Check for the specific 401 error message if available
            if (error.message.includes("Status 401") || error.message.includes("Unauthorized")) {
                messageDiv.textContent = "Authentication Failed: Please ensure you are logged in correctly.";
            } else {
                messageDiv.textContent = `Course Load Error: ${error.message}`;
            }
            console.error('Final Load Error:', error);
        }
    }

    // =========================================================
    // 4. SCORM API IMPLEMENTATION (Minimal Stub for Communication) (Kept the same)
    
    window.API = {
        LMSInitialize: function(param) { console.log("SCORM: LMSInitialize called."); return "true"; },
        LMSFinish: function(param) { console.log("SCORM: LMSFinish called."); return "true"; },
        LMSGetValue: function(element) { console.log("SCORM: LMSGetValue called for " + element); return ""; },
        LMSSetValue: function(element, value) { console.log(`SCORM: LMSSetValue called for ${element} with value ${value}`); return "true"; },
        LMSCommit: function(param) { console.log("SCORM: LMSCommit called."); return "true"; },
        LMSGetLastError: function() { return "0"; },
        LMSGetErrorString: function(errorCode) { return "No Error"; },
        LMSGetDiagnostic: function(errorCode) { return ""; }
    };

    window.findAPI = function(win) {
        if (win.API) {
            return win.API;
        } else if (win.parent && win.parent !== win) {
            return findAPI(win.parent);
        } else if (win.opener && win.opener !== win) {
            return findAPI(win.opener);
        }
        return null;
    };

    // Start loading the course when the page loads
    document.addEventListener('DOMContentLoaded', loadCourse);

</script>

</body>
</html>
