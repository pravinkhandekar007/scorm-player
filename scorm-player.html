<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SCORM Course Player</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
    }
    #player-container {
      max-width: 1200px;
      margin: 20px auto;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    h2 {
      margin: 0;
      padding: 20px;
      background: #2c3e50;
      color: #fff;
      text-align: center;
      font-size: 1.5rem;
    }
    #message {
      padding: 20px;
      text-align: center;
      color: #333;
    }
    iframe {
      width: 100%;
      height: 80vh;
      border: none;
    }
  </style>
</head>
<body>
  <div id="player-container">
    <h2>ðŸŽ“ SCORM Course Player</h2>
    <div id="message">Loading courseâ€¦</div>
    <iframe id="course-iframe" title="SCORM Content"></iframe>
  </div>

  <script>
    // Replace with your actual Supabase details
    const SUPABASE_URL = "https://kfksfnzpudycqbcftrev.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtma3NmbnpwdWR5Y3FiY2Z0cmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODg1MzcsImV4cCI6MjA3NDI2NDUzN30.l0ApEczfprHX9m73tiCWzO2cJRGBpic9RDJWQsw7qfs";

    const messageDiv = document.getElementById("message");
    const iframe = document.getElementById("course-iframe");

    async function loadCourse() {
      const params = new URLSearchParams(window.location.search);
      const courseSlug = params.get("course");
      if (!courseSlug) {
        messageDiv.textContent = "Error: Missing course slug in URL.";
        return;
      }

      messageDiv.textContent = "Fetching course metadataâ€¦";
      // 1) Fetch metadata from get-course function
      const metaRes = await fetch(
        `${SUPABASE_URL}/functions/v1/get-course/${courseSlug}?apikey=${SUPABASE_ANON_KEY}`
      );
      if (!metaRes.ok) {
        messageDiv.textContent = `Metadata fetch error: ${metaRes.status}`;
        return;
      }
      const course = await metaRes.json();

      messageDiv.textContent = "Loading course contentâ€¦";
      // 2) Construct public URL for manifest
      const manifestUrl =
        `${SUPABASE_URL}/storage/v1/object/public/scorm-packages/` +
        `${course.package_path}/imsmanifest.xml`;

      // 3) Verify manifest loads
      const mRes = await fetch(manifestUrl);
      if (!mRes.ok) {
        messageDiv.textContent = `Manifest fetch error: ${mRes.status}`;
        return;
      }

      // 4) Construct public URL for launch file
      const launchUrl =
        `${SUPABASE_URL}/storage/v1/object/public/scorm-packages/` +
        `${course.package_path}/${course.launch_url}`;

      // 5) Set iframe source and hide message
      iframe.src = launchUrl;
      messageDiv.style.display = "none";
    }

    document.addEventListener("DOMContentLoaded", loadCourse);
  </script>
</body>
</html>
