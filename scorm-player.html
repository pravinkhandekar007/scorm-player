<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCORM Course Player</title>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f4f4f4; }
        #player-container { width: 100%; max-width: 1200px; margin: 20px auto; background-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #course-iframe { width: 100%; height: 600px; border: none; }
        #message { padding: 20px; text-align: center; color: red; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div id="player-container">
    <h2>SCORM Course Player</h2>
    <div id="message">Loading...</div>
    <iframe id="course-iframe" src="" allowfullscreen></iframe>
</div>

<script>
    // =========================================================
    // 1. CONFIGURATION (MUST BE ACCESSIBLE)
    // IMPORTANT: Replace these placeholders with your actual Supabase details
    // Ensure these variables are correctly available in your environment (e.g., loaded from a config file or defined here)
    const SUPABASE_URL = 'https://kfksfnzpudycqbcftrev.supabase.co'; // Your actual Supabase URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtma3NmbnpwdWR5Y3FiY2Z0cmV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2ODg1MzcsImV4cCI6MjA3NDI2NDUzN30.l0ApEczfprHX9m73tiCWzO2cJRGBpic9RDJWQsw7qfs'; // Your actual Supabase public anon key

    // Initialize Supabase Client
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const messageDiv = document.getElementById('message');
    const iframe = document.getElementById('course-iframe');

    // =========================================================
    // 2. AUTHORIZATION AND FILE FETCHING (CRITICAL FIX)
    // This function fetches files from Edge Function 3 (proxy-scorm)
    async function loadCourseFile(filePath) {
        const courseSlug = new URLSearchParams(window.location.search).get('course');
        
        // Retrieve the current user session/JWT
        const { data: { session } } = await supabase.auth.getSession(); 
        
        if (!session || !session.access_token) {
            console.error("User session is not available. Please log in.");
            throw new Error("User not authorized.");
        }
        
        // Construct the URL to the proxy-scorm Edge Function
        const fileUrl = `${SUPABASE_URL}/functions/v1/proxy-scorm/${courseSlug}/${filePath}`;

        const response = await fetch(fileUrl, {
            method: 'GET',
            headers: {
                // FIX: Send the JWT for authorization in Edge Function 3
                'Authorization': `Bearer ${session.access_token}`, 
                'apikey': SUPABASE_ANON_KEY, 
            }
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`Error loading file ${filePath}: Status ${response.status}`, errorText);
            throw new Error(`Failed to load file (${filePath}): Status ${response.status}`);
        }

        // Return raw data as ArrayBuffer for binary/text handling
        return response.arrayBuffer(); 
    }

    // =========================================================
    // 3. SCORM MANIFEST PARSING AND LAUNCH LOGIC

    /**
     * Finds the launch URL from the imsmanifest.xml content.
     * @param {string} xmlString - The raw XML content of imsmanifest.xml.
     * @returns {string} The launch URL (e.g., 'scormcontent/index.html').
     */
    function extractLaunchUrl(xmlString) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "application/xml");
            
            // Check for XML parsing errors
            if (xmlDoc.getElementsByTagName("parsererror").length) {
                console.error("XML Parsing Error:", xmlDoc.getElementsByTagName("parsererror")[0].textContent);
                throw new Error("Invalid SCORM manifest XML.");
            }

            // Look for the main resource in the manifest (SCORM 1.2 typically)
            // Finds the <resource> element with an 'href' attribute
            const resource = xmlDoc.querySelector('resource[href]');

            if (resource) {
                return resource.getAttribute('href');
            }

            // Fallback for more complex manifests (SCORM 2004) - look for the first <item> in <organizations>
            const defaultActivity = xmlDoc.querySelector('organization[default="true"] > item[identifierref][identifier]');
            if (defaultActivity) {
                const identifierRef = defaultActivity.getAttribute('identifierref');
                const resourceByRef = xmlDoc.querySelector(`resource[identifier="${identifierRef}"][href]`);
                if (resourceByRef) {
                    return resourceByRef.getAttribute('href');
                }
            }

            console.warn("Could not find launch URL in manifest. Defaulting to index.html.");
            return 'index.html'; // Default SCORM launch file name
            
        } catch (e) {
            console.error("Error processing manifest:", e);
            messageDiv.textContent = `Error processing manifest: ${e.message}`;
            return null;
        }
    }

    async function loadCourse() {
        messageDiv.textContent = "Authenticating and fetching manifest...";
        const courseSlug = new URLSearchParams(window.location.search).get('course');
        
        if (!courseSlug) {
            messageDiv.textContent = "Error: Missing 'course' slug in the URL.";
            return;
        }

        try {
            // 1. Fetch the imsmanifest.xml file using the authorized function
            const manifestArrayBuffer = await loadCourseFile('imsmanifest.xml');
            
            // Convert ArrayBuffer to string (manifest is always text/XML)
            const manifestString = new TextDecoder('utf-8').decode(manifestArrayBuffer);

            // 2. Extract the launch URL
            const launchUrl = extractLaunchUrl(manifestString);

            if (!launchUrl) {
                messageDiv.textContent = "Error: Failed to determine the course launch URL from manifest.";
                return;
            }

            // 3. Prepare the final launch URL to the proxy function
            const finalLaunchPath = `${SUPABASE_URL}/functions/v1/proxy-scorm/${courseSlug}/${launchUrl}`;
            
            // 4. Set the iframe source
            iframe.src = finalLaunchPath;
            messageDiv.textContent = `Course loaded: ${launchUrl}`;
            messageDiv.style.color = 'green';
            
        } catch (error) {
            messageDiv.textContent = `Course Load Error: ${error.message}`;
            console.error('Final Load Error:', error);
        }
    }

    // =========================================================
    // 4. SCORM API IMPLEMENTATION (Minimal Stub for Communication)
    // The SCORM content expects to find an API object in the window scope.
    // This is a minimal stub to prevent SCORM packages from crashing instantly.

    window.API = {
        LMSInitialize: function(param) { 
            console.log("SCORM: LMSInitialize called.");
            return "true"; 
        },
        LMSFinish: function(param) { 
            console.log("SCORM: LMSFinish called.");
            return "true"; 
        },
        LMSGetValue: function(element) { 
            console.log("SCORM: LMSGetValue called for " + element);
            return ""; // Return empty string for now
        },
        LMSSetValue: function(element, value) { 
            console.log(`SCORM: LMSSetValue called for ${element} with value ${value}`);
            // This is where you would call a backend function (Edge Function 2) to save data
            return "true"; 
        },
        LMSCommit: function(param) { 
            console.log("SCORM: LMSCommit called.");
            // This is where you would call Edge Function 2 to save all pending data
            return "true"; 
        },
        LMSGetLastError: function() { 
            return "0"; // No error
        },
        LMSGetErrorString: function(errorCode) { 
            return "No Error"; 
        },
        LLMSGetDiagnostic: function(errorCode) { 
            return ""; 
        }
    };

    // The course content often searches for the API object in parent/opener windows
    window.findAPI = function(win) {
        if (win.API) {
            return win.API;
        } else if (win.parent && win.parent != win) {
            return findAPI(win.parent);
        } else if (win.opener && win.opener != win) {
            return findAPI(win.opener);
        }
        return null;
    };

    // Start loading the course when the page loads
    document.addEventListener('DOMContentLoaded', loadCourse);

</script>

</body>
</html>
